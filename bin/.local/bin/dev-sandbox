#!/usr/bin/env bash
set -euo pipefail

MACHINE="dev-sandbox"
ROOT="/var/lib/machines/${MACHINE}"

# Host dotfiles (read-only mounts into container)
DOTFILES_PUBLIC="${HOME}/.dotfiles"
DOTFILES_PRIVATE="${HOME}/.dotfiles-private"

# Container mount points
C_DOTFILES_PUBLIC="/opt/host-dotfiles"
C_DOTFILES_PRIVATE="/opt/host-dotfiles-private"

# Disable systemd terminal tint/title/emoji adjustments (keep host kitty colors intact)
SYSTEMD_TTY_ENV=(
  "SYSTEMD_TINT_BACKGROUND=0"
  "SYSTEMD_ADJUST_TERMINAL_TITLE=0"
  "SYSTEMD_EMOJI=0"
)

usage() {
  cat >&2 <<EOF
Usage: $(basename "$0") [OPTIONS] [PROJECT_PATH]

Default (no options):
  Project mode: bind-mount PROJECT_PATH (or \$PWD) into /workspace/<project-name> and start a fish shell
  as user 'dev' in that directory. Also bind-mount dotfiles read-only.

Shell mode:
  -S, --shell [USER]      Start a shell in the container (no project mount).
                          If USER is omitted, defaults to root.
  -D, --shell-dev         Shortcut for --shell dev
  -h, --help              Show this help message

Examples:
  $(basename "$0")                     # project mode: mount \$PWD, start dev shell
  $(basename "$0") /path/to/project    # project mode: mount project, start dev shell
  $(basename "$0") -S                  # shell mode: root shell, no project mount
  $(basename "$0") -S dev              # shell mode: dev shell, no project mount
  $(basename "$0") -D                  # shell mode: dev shell, no project mount
EOF
  exit 1
}

# Check rootfs existence early
if ! sudo test -d "$ROOT"; then
  echo "Error: container rootfs not found at $ROOT" >&2
  exit 1
fi

# Parse arguments
SHELL_MODE=0
SHELL_USER=""
PROJECT_PATH=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    -S|--shell)
      SHELL_MODE=1
      shift
      # Optional USER argument: if next token exists and is not another option, treat as USER.
      if [[ $# -gt 0 && "${1:-}" != -* ]]; then
        SHELL_USER="$1"
        shift
      else
        SHELL_USER="root"
      fi
      ;;
    -D|--shell-dev)
      SHELL_MODE=1
      SHELL_USER="dev"
      shift
      ;;
    -h|--help)
      usage
      ;;
    -*)
      echo "Error: unknown option: $1" >&2
      usage
      ;;
    *)
      if [[ -n "$PROJECT_PATH" ]]; then
        echo "Error: multiple project paths provided" >&2
        exit 1
      fi
      PROJECT_PATH="$1"
      shift
      ;;
  esac
done

# Common dotfiles mounts (read-only, only if present)
DOTFILES_MOUNTS=()
if [[ -d "$DOTFILES_PUBLIC" ]]; then
  DOTFILES_MOUNTS+=( "--bind-ro=${DOTFILES_PUBLIC}:${C_DOTFILES_PUBLIC}" )
fi
if [[ -d "$DOTFILES_PRIVATE" ]]; then
  DOTFILES_MOUNTS+=( "--bind-ro=${DOTFILES_PRIVATE}:${C_DOTFILES_PRIVATE}" )
fi

# ==============================================================================
# MODE 1/2: SHELL MODE (NO PROJECT MOUNT)
# ==============================================================================
if [[ "$SHELL_MODE" -eq 1 ]]; then
  if [[ -n "$PROJECT_PATH" ]]; then
    echo "Error: cannot specify PROJECT_PATH with --shell options" >&2
    exit 1
  fi

  # Root is the default for systemd-nspawn; omitting --user is effectively "root".
  NSPAWN_USER_ARGS=()
  if [[ -n "${SHELL_USER:-}" && "$SHELL_USER" != "root" ]]; then
    NSPAWN_USER_ARGS=( "--user=$SHELL_USER" )
  fi

  exec sudo env "${SYSTEMD_TTY_ENV[@]}" systemd-nspawn \
    -M "$MACHINE" \
    -D "$ROOT" \
    "${DOTFILES_MOUNTS[@]}" \
    "${NSPAWN_USER_ARGS[@]}" \
    -E "DEV_SANDBOX=${MACHINE}" \
    /usr/bin/fish
fi

# ==============================================================================
# MODE 2/2: PROJECT MODE (DEFAULT)
# ==============================================================================
if [[ -z "$PROJECT_PATH" ]]; then
  PROJECT_PATH="$PWD"
fi

PROJECT_PATH="$(readlink -f "$PROJECT_PATH")"
PROJECT_NAME="$(basename "$PROJECT_PATH")"

if [[ ! -d "$PROJECT_PATH" ]]; then
  echo "Error: project directory '$PROJECT_PATH' does not exist." >&2
  exit 1
fi

exec sudo env "${SYSTEMD_TTY_ENV[@]}" systemd-nspawn \
  -M "$MACHINE" \
  -D "$ROOT" \
  --user=dev \
  --bind="${PROJECT_PATH}:/workspace/${PROJECT_NAME}" \
  "${DOTFILES_MOUNTS[@]}" \
  -E "DEV_SANDBOX=${MACHINE}" \
  /usr/bin/fish -lc "mkdir -p /workspace/${PROJECT_NAME} && cd /workspace/${PROJECT_NAME} && exec fish"
